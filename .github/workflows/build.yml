name: Narzo 50 Stable Build (Official KSU)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 1. Checkout Code
      uses: actions/checkout@v2

    - name: 2. Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev libncurses5-dev \
        libelf-dev git curl python3 zip gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

    - name: 3. Setup Neutron Clang
      run: |
        mkdir -p clang
        cd clang
        curl -LO "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman"
        chmod +x antman
        ./antman -S
        
    - name: 4. Clone Source
      run: |
        git clone --depth=1 https://github.com/realme-mt6781-dev/android_kernel_realme_mt6781.git kernel_source

    - name: 5. REPAIR BROKEN SOURCE
      run: |
        cd kernel_source
        # মিসিং ড্রাইভার ফিক্স (যেটা আগে এরর দিচ্ছিল)
        mkdir -p drivers/soc/oplus/system/acm
        echo "obj-n := dummy.o" > drivers/soc/oplus/system/acm/Makefile

    - name: 6. Install Official KernelSU (Stable)
      run: |
        cd kernel_source
        echo "--- Installing Official KernelSU ---"
        # KSU-Next এর বদলে অফিসিয়াল KSU ব্যবহার করছি যা 4.19 এ ক্র্যাশ করে না
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: 7. Configure Kernel
      run: |
        cd kernel_source
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        
        make O=out spaced_defconfig
        
        echo "--- APPLYING PATCHES ---"
        # ১. LTO বন্ধ করা (র‍্যাম ও এরর বাঁচাবে)
        sed -i 's/CONFIG_LTO=y/CONFIG_LTO=n/' out/.config
        sed -i 's/CONFIG_LTO_CLANG=y/CONFIG_LTO_CLANG=n/' out/.config
        sed -i 's/CONFIG_THINLTO=y/CONFIG_THINLTO=n/' out/.config
        echo "CONFIG_LTO_NONE=y" >> out/.config
        
        # ২. Werror বন্ধ করা
        sed -i 's/CONFIG_CC_WERROR=y/CONFIG_CC_WERROR=n/' out/.config
        
        # ৩. KernelSU অন করা
        echo "CONFIG_KSU=y" >> out/.config

        make O=out olddefconfig

    - name: 8. Build Kernel
      run: |
        cd kernel_source
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export KBUILD_BUILD_USER="Kafi-Stable"
        export KBUILD_BUILD_HOST="Narzo-Lab"
        
        echo "--- Starting Build ---"
        make -j$(nproc --all) O=out \
                              CC=clang \
                              LD=ld.lld \
                              AR=llvm-ar \
                              NM=llvm-nm \
                              OBJCOPY=llvm-objcopy \
                              OBJDUMP=llvm-objdump \
                              STRIP=llvm-strip \
                              CROSS_COMPILE=aarch64-linux-gnu- \
                              CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                              Image.gz-dtb

    - name: 9. Create Zip
      run: |
        if [ ! -f kernel_source/out/arch/arm64/boot/Image.gz-dtb ]; then
            echo "CRITICAL ERROR: Kernel Image not found!"
            exit 1
        fi
        
        git clone https://github.com/osm0sis/AnyKernel3.git
        cp kernel_source/out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        cd AnyKernel3
        rm -rf .git README.md .gitignore
        zip -r9 ../Narzo50-Official-KSU.zip *

    - name: 10. Upload
      uses: actions/upload-artifact@v4
      with:
        name: Narzo50-Perf-Kernel
        path: Narzo50-Perf-Build.zip
